# Lab 2-3 (ì¶”ê°€): KServe Canary ë°°í¬ ì‹¤ìŠµ

## ğŸ“‹ ì‹¤ìŠµ ê°œìš”

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ì‹¤ìŠµ íŒŒì¼** | `kserve_canary_deploy_boto3.ipynb` |
| **ì†Œìš”ì‹œê°„** | 40ë¶„ |
| **ë‚œì´ë„** | â­â­â­â­ |
| **ì‚¬ì „ ìš”êµ¬ì‚¬í•­** | Lab 2-3 ê¸°ë³¸ ë°°í¬ ì™„ë£Œ (InferenceService Ready ìƒíƒœ) |

---

## ğŸ¯ í•™ìŠµ ëª©í‘œ

- KServe Canary ë°°í¬ ê°œë… ì´í•´
- íŠ¸ë˜í”½ ì ì§„ì  ì „í™˜ (20% â†’ 50% â†’ 100%)
- kubectlë¡œ Canary ìƒíƒœ ëª¨ë‹ˆí„°ë§
- ë¡¤ë°± ë° ìŠ¹ê²© ìˆ˜í–‰

---

## ğŸ”„ KServe Canary ë°°í¬ ì›ë¦¬

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Canary ë°°í¬ íë¦„                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Step 1: canaryTrafficPercent: 20                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ Revision-001 (80%)  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘  â”‚  â† V1 (ê¸°ì¡´) â”‚
â”‚  â”‚ Revision-002 (20%)  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚  â† V2 (ì‹ ê·œ) â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                         â†“                                   â”‚
â”‚  Step 2: canaryTrafficPercent: 50                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ Revision-001 (50%)  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚               â”‚
â”‚  â”‚ Revision-002 (50%)  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                         â†“                                   â”‚
â”‚  Step 3: canaryTrafficPercent ì œê±° â†’ ìŠ¹ê²©                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ Revision-002 (100%) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â”‚  â† ìƒˆ Defaultâ”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### í•µì‹¬ ë™ì‘

| ë™ì‘ | ë°©ë²• |
|------|------|
| ìƒˆ Revision ìƒì„± | `storageUri` ë³€ê²½ |
| íŠ¸ë˜í”½ ë¶„í•  | `canaryTrafficPercent` ì„¤ì • |
| ìŠ¹ê²© | `canaryTrafficPercent` ì œê±° |
| ë¡¤ë°± | ì›ë˜ `storageUri`ë¡œ ë³µì› |

---

## ğŸ““ ë…¸íŠ¸ë¶ ì‹¤ìŠµ ìˆœì„œ

| ì„¹ì…˜ | ë‚´ìš© | ì‹œê°„ |
|------|------|------|
| 1 | í™˜ê²½ ì„¤ì • + AWS ìê²©ì¦ëª… | 3ë¶„ |
| 2 | í˜„ì¬ InferenceService í™•ì¸ | 2ë¶„ |
| 3 | V2 ëª¨ë¸ í•™ìŠµ ë° MLflow ë“±ë¡ | 5ë¶„ |
| 4 | Canary ë°°í¬ (20%) | 5ë¶„ |
| 5 | íŠ¸ë˜í”½ ë¶„í•  ê²€ì¦ | 3ë¶„ |
| 6 | íŠ¸ë˜í”½ ì¦ê°€ (50%) | 3ë¶„ |
| 7 | ë¡¤ë°± ì „ëµ (ì°¸ê³ ) | 2ë¶„ |
| 8 | Canary ìŠ¹ê²© (100%) | 3ë¶„ |

---

## ğŸ–¥ï¸ kubectlë¡œ Canary ìƒíƒœ í™•ì¸

### 1. ê¸°ë³¸ ìƒíƒœ í™•ì¸

```bash
kubectl get inferenceservice -n kubeflow-user{USER_NUM}
```

**ì¶œë ¥ ì˜ˆì‹œ:**
```
NAME                      READY   PREV   LATEST   AGE
california-model-user20   True    80     20       5h
                                  â†‘      â†‘
                                V1(80%) V2(20%)
```

### 2. íŠ¸ë˜í”½ ë¶„ë°° ìƒì„¸ í™•ì¸

```bash
kubectl get isvc california-model-user{USER_NUM} -n kubeflow-user{USER_NUM} \
  -o jsonpath='{.status.components.predictor.traffic}' | jq .
```

**ì¶œë ¥ ì˜ˆì‹œ:**
```json
[
  {"revisionName": "california-model-user20-predictor-00001", "percent": 80},
  {"revisionName": "california-model-user20-predictor-00002", "percent": 20, "latestRevision": true}
]
```

### 3. Canary ì„¤ì •ê°’ í™•ì¸

```bash
kubectl get isvc california-model-user{USER_NUM} -n kubeflow-user{USER_NUM} \
  -o jsonpath='{.spec.predictor.canaryTrafficPercent}'
```

### 4. Revision ëª©ë¡ í™•ì¸

```bash
kubectl get revision -n kubeflow-user{USER_NUM} \
  -l serving.kserve.io/inferenceservice=california-model-user{USER_NUM}
```

### 5. ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§

```bash
watch -n 2 "kubectl get isvc -n kubeflow-user{USER_NUM}"
```

---

## ğŸ”§ kubectlë¡œ íŠ¸ë˜í”½ ì¡°ì •

```bash
# íŠ¸ë˜í”½ 50%ë¡œ ì¦ê°€
kubectl patch isvc california-model-user{USER_NUM} -n kubeflow-user{USER_NUM} \
  --type='json' -p='[{"op": "replace", "path": "/spec/predictor/canaryTrafficPercent", "value": 50}]'

# Canary ìŠ¹ê²© (100%)
kubectl patch isvc california-model-user{USER_NUM} -n kubeflow-user{USER_NUM} \
  --type='json' -p='[{"op": "remove", "path": "/spec/predictor/canaryTrafficPercent"}]'
```

---

## ğŸ“ í•µì‹¬ ì½”ë“œ ìš”ì•½

### Canary ë°°í¬ YAML
```yaml
spec:
  predictor:
    canaryTrafficPercent: 20
    model:
      storageUri: "s3://bucket/path/to/v2/model"
```

### Python ì½”ë“œ
```python
# íŠ¸ë˜í”½ ì¡°ì •
isvc["spec"]["predictor"]["canaryTrafficPercent"] = 50

# ìŠ¹ê²©
del isvc["spec"]["predictor"]["canaryTrafficPercent"]

# ë¡¤ë°±
isvc["spec"]["predictor"]["model"]["storageUri"] = original_uri
```

---

## âœ… ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] V2 ëª¨ë¸ í•™ìŠµ ë° S3 ì €ì¥
- [ ] Canary ë°°í¬ ì ìš© (20%)
- [ ] kubectlë¡œ íŠ¸ë˜í”½ í™•ì¸
- [ ] íŠ¸ë˜í”½ 50%ë¡œ ì¦ê°€
- [ ] Canary ìŠ¹ê²© (100%)

---

Â© 2025 í˜„ëŒ€ì˜¤í† ì—ë²„ MLOps Training
